<!-- 52957 Data representation -->
<!-- Big project 2019 -->
<!-- shopperx.html-->

<!DOCTYPE html>
<html>
    <head>
        <title>Shopping</title>

        <!--Include BootstrapCSS only, spreads content more across width of page-->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" 
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

        <!--link to JQuery in here-->
        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>

    </head>

    <body>

        <!-- Add an image, maybe more/position? -->
        <img src="images/istock_trolley.jpg" alt="Trolley in a supermarket" style="width:300px;height:155px;">

        <h1>Foods</h1>
        <!--the Foods section-->
        <div>
        <!--give Create button id-->
        <button id="showCreateButton" onclick="showCreate()">Create</button>
        </div>

        <h1>All Foods</h1>
<!--List all the foods - will load from server/DB later-->
        <div>
            <table class="table" id="foodTable">
                <tr>
                    <th>id</th>  <!-- maybe don't display id? -->
                    <th>Category</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Update</th>
                    <th>Delete</th>
                </tr>
                <!-- blank table to start-->
            </table>
        </div>

<!--The Update & Create section-->
        
        <!--hide the form-->
        <div id='createUpdateForm' style="display:none">
            <h2><span id="createLabel" style="color: blue">Create a</span> <span id="updateLabel"style="color: red">Update</span> Food</h2>

            ID <input type="text" name="id"/> <br/> <!-- hide later: <input type="hidden" name="id"/> -->
            Category <select name="Category">
                <option value="Dairy">Dairy</option>
                <option value="Vegetable">Vegetables</option>
                <option value="Meat">Meat</option>
                <option value="Canned">Canned</option>
                </select><br/>
            Name<input type="text" name="name"/> <br/>
            Price <input type="number" name="price"/> <br/>
            <span><button id="doCreateButton" onclick="doCreate()">Create</button></span>
            <span><button id="doUpdateButton" onclick="doUpdate()">Update</button></span>

        </div>

        <!-- JavaScript goes here -->
        <script>

        function showCreate(){
            // When creating a new food:
            // Hide showCreateButton & foodTable, show createUpdateForm
            document.getElementById('showCreateButton').style.display="none"
            document.getElementById('foodTable').style.display="none"
            document.getElementById('createUpdateForm').style.display="block"

            // Show createLabel above form, hide updateLabel
            document.getElementById('createLabel').style.display="inline"
            document.getElementById('updateLabel').style.display="none"

            // Show doCreateButton under form, hide doUpdateButton
            document.getElementById('doCreateButton').style.display="block"
            document.getElementById('doUpdateButton').style.display="none"
        }

        function showViewAll(){
            document.getElementById('showCreateButton').style.display="block"
            document.getElementById('foodTable').style.display="block"
            document.getElementById('createUpdateForm').style.display="none"
        }

        function showUpdate(buttonElement){
            document.getElementById('showCreateButton').style.display="none"
            document.getElementById('foodTable').style.display="none"
            document.getElementById('createUpdateForm').style.display="block"
            document.getElementById('createLabel').style.display="none"
            document.getElementById('updateLabel').style.display="inline"
            document.getElementById('doCreateButton').style.display="none"
            document.getElementById('doUpdateButton').style.display="block"
            var rowElement = buttonElement.parentNode.parentNode
            // these is a way of finding the closest <tr> which would safer, closest()
        
            var food = getFoodFromRow(rowElement)
            populateFormWithFood(food)
        }

        function doCreate(){
            console.log("inside doCreate in form")
            var form = document.getElementById('createUpdateForm')
            var food = {}
            
            // id created by DB
            food.Category = form.querySelector('select[name="Category"]').value
            food.Name = form.querySelector('input[name="Name"]').value
            food.Price = form.querySelector('input[name="Price"]').value
            console.log(JSON.stringify(food))

            // ajax POST to server here.
            ////////////////////////////////////////////////////////////////
            //createFoodAjax(food)
        }

        function doUpdate(){
            // calls getFoodFromForm and setFoodInRow
            console.log("inside doUpdate")
            var food = getFoodFromForm();
            var rowElement = document.getElementById(food.id);

            // ajax PUT to server here.
            ////////////////////////////////////////////////////////////////
            console.log("updateFood on server now - ajax PUT next line")
            console.log(JSON.stringify(food));
            //AJupdateFood(food);
                
            setFoodInRow(rowElement, food); //table is being updated
            clearForm()
            showViewAll()
        }
            
        function doDelete(r){
            console.log("delete button in table has been clicked")
            var tableElement = document.getElementById('foodTable');
            var rowElement = r.parentNode.parentNode;
            var index = rowElement.rowIndex;

            // ajax DELETE from server here.
            ////////////////////////////////////////////////////////////////
            //deleteFoodAjax(rowElement.getAttribute("id"));

            tableElement.deleteRow(index); // table is being updated
        }
            
        function addFoodToTable(food){
            var tableElement = document.getElementById('foodTable')
            var rowElement = tableElement.insertRow(-1)
            rowElement.setAttribute('id',food.id)
            var cell1 = rowElement.insertCell(0);
            cell1.innerHTML = food.id
            var cell2 = rowElement.insertCell(1);
            cell2.innerHTML = food.Category
            var cell3 = rowElement.insertCell(2);
            cell3.innerHTML = food.Name
            var cell4 = rowElement.insertCell(3);
            cell4.innerHTML = food.Price
            var cell5 = rowElement.insertCell(4);
            cell5.innerHTML = '<button onclick="showUpdate(this)">Update</button>'
            var cell6 = rowElement.insertCell(5);
            cell6.innerHTML = '<button onclick=doDelete(this)>delete</button>'
        }

        function clearForm(){
            var form = document.getElementById('createUpdateForm')
            form.querySelector('select[name="Category"]').value=''
            form.querySelector('input[name="Name"]').value=''
            form.querySelector('input[name="Price"]').value=''
        }

        function getFoodFromRow(rowElement){
            // Take a row el and return a food object
            console.log("inside getFoodFromRow")
            var food = {}
            //food.id = rowElement.cells[0].firstChild.textContent
            food.id = rowElement.getAttribute('id')
            food.Category = rowElement.cells[1].firstChild.textContent
            food.Name = rowElement.cells[2].firstChild.textContent
            food.Price = parseInt(rowElement.cells[3].firstChild.textContent,10)
            return food
            console.log(food)
        }

        function setFoodInRow(rowElement, food){
            // Take food and rowEl and pop the row with the food
            rowElement.cells[0].firstChild.textContent= food.id
            rowElement.cells[1].firstChild.textContent= food.Category
            rowElement.cells[2].firstChild.textContent= food.Name
            rowElement.cells[3].firstChild.textContent= food.Price
        }

        function populateFormWithFood(food){
            var form = document.getElementById('createUpdateForm')
            
            form.querySelector('input[name="id"]').disabled = true

            form.querySelector('input[name="id"]').value = food.id
            form.querySelector('select[name="Category"]').value = food.Category
            form.querySelector('input[name="Name"]').value = food.Name
            form.querySelector('input[name="Price"]').value = food.Price
        }

        function getFoodFromForm(){
            // Return a food from the form
            console.log("in getFoodFromForm")
            var form = document.getElementById('createUpdateForm')
            var food = {}
            food.id = form.querySelector('input[name="id"]').value
            food.Category = form.querySelector('select[name="Category"]').value
            food.Name = form.querySelector('input[name="Name"]').value
            // My price is a decimal(6.2)
            //food.Price = parseInt(form.querySelector('input[name="Price"]').value,10)
            food.Price = form.querySelector('input[name="Price"]').value
            console.log(JSON.stringify(food))
            return food
        }  
        
        // AJAX functions below.
        /////////////////////////////////////////////////////////////////////////

        function getAllAjax(){
            $.ajax({
                "url": "http://127.0.0.1:5000/foods",
                "method":"GET",
                "data":"",
                "dataType": "JSON",
                "success":function(result){
                    //console.log(result);
                    for (food of result){
                        addFoodToTable(food);
                    }
                },
                "error":function(xhr,status,error){
                    console.log("error: "+status+" msg:"+error);
                }
            });
        }
        
        getAllAjax(); // Fill table with data from DB
        </script>

    </body>

</html>